{% extends "base.html" %}

{% block title %}AI ì±—ë´‡ - KAMCO ìˆ˜ì§‘ ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .chat-header {
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .message {
        display: flex;
        gap: 0.75rem;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        order: 2;
    }
    
    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .message-content {
        max-width: 70%;
        padding: 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message.assistant .message-content {
        background: white;
        border: 1px solid #dee2e6;
        color: #212529;
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-sources {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #dee2e6;
    }
    
    .source-item {
        font-size: 0.85rem;
        color: #6c757d;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
    
    .chat-input-container {
        padding: 1rem;
        background: white;
        border-radius: 0 0 0.5rem 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .chat-input-form {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input {
        flex: 1;
        border-radius: 2rem;
        padding: 0.75rem 1.25rem;
        border: 1px solid #dee2e6;
    }
    
    .chat-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        border-color: #667eea;
    }
    
    .chat-send-btn {
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.2rem;
        transition: transform 0.2s;
    }
    
    .chat-send-btn:hover {
        transform: scale(1.1);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.6;
        transform: none;
    }
    
    .typing-indicator {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.5;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }
    
    .example-questions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .example-question {
        padding: 1rem;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }
    
    .example-question:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(102, 126, 234, 0.1);
    }
    
    .example-question i {
        color: #667eea;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="bi bi-robot"></i> KAMCO AI ì±—ë´‡
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="chat-container">
            <div class="chat-header">
                <i class="bi bi-robot"></i>
                <div class="flex-grow-1">
                    <strong>KAMCO AI ì–´ì‹œìŠ¤í„´íŠ¸</strong>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        ê³µë§¤ ë°ì´í„°ì— ëŒ€í•´ ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ì„¸ìš”
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-light" id="resetChatBtn" title="ì±— ê¸°ë¡ ì´ˆê¸°í™”">
                    <i class="bi bi-arrow-clockwise"></i> ì´ˆê¸°í™”
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        ì•ˆë…•í•˜ì„¸ìš”! KAMCO ê³µë§¤ ë°ì´í„° AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ğŸ <br><br>
                        ê¶ê¸ˆí•˜ì‹  ê³µë§¤ ë¬¼ê±´ì— ëŒ€í•´ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.<br>
                        ì˜ˆ: "ì„œìš¸ì— ìˆëŠ” ì•„íŒŒíŠ¸ ì°¾ì•„ì¤˜", "ë¶€ì‚° 3ì–µì› ì´í•˜ ë¬¼ê±´ ì¶”ì²œí•´ì¤˜"
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <input 
                        type="text" 
                        class="form-control chat-input" 
                        id="chatInput" 
                        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                        autocomplete="off"
                        required
                    >
                    <button type="submit" class="btn chat-send-btn" id="sendBtn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-lightbulb"></i> ì˜ˆì‹œ ì§ˆë¬¸
                </h5>
                <div class="example-questions">
                    <div class="example-question" data-question="ì„œìš¸ì— ìˆëŠ” ì•„íŒŒíŠ¸ ì°¾ì•„ì¤˜">
                        <i class="bi bi-building"></i>
                        <div><strong>ì§€ì—­ë³„ ê²€ìƒ‰</strong></div>
                        <small class="text-muted">ì„œìš¸ì— ìˆëŠ” ì•„íŒŒíŠ¸ ì°¾ì•„ì¤˜</small>
                    </div>
                    
                    <div class="example-question" data-question="ë¶€ì‚°ì— ìˆëŠ” 3ì–µì› ì´í•˜ ë¶€ë™ì‚° ì¶”ì²œí•´ì¤˜">
                        <i class="bi bi-currency-dollar"></i>
                        <div><strong>ê°€ê²©ëŒ€ë³„ ê²€ìƒ‰</strong></div>
                        <small class="text-muted">ë¶€ì‚° 3ì–µì› ì´í•˜ ì¶”ì²œ</small>
                    </div>
                    
                    <div class="example-question" data-question="ìµœê·¼ì— ì˜¬ë¼ì˜¨ ë¬¼ê±´ë“¤ ë³´ì—¬ì¤˜">
                        <i class="bi bi-clock-history"></i>
                        <div><strong>ìµœì‹  ë¬¼ê±´</strong></div>
                        <small class="text-muted">ìµœê·¼ ê³µë§¤ ë¬¼ê±´ ì¡°íšŒ</small>
                    </div>
                    
                    <div class="example-question" data-question="ê°•ë‚¨êµ¬ì— ìˆëŠ” ì˜¤í”¼ìŠ¤í…” ì•Œë ¤ì¤˜">
                        <i class="bi bi-house-door"></i>
                        <div><strong>ë¬¼ê±´ ìœ í˜•ë³„</strong></div>
                        <small class="text-muted">ì˜¤í”¼ìŠ¤í…” ê²€ìƒ‰</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-info-circle"></i> ì‚¬ìš© ì•ˆë‚´
                </h6>
                <ul class="small mb-0">
                    <li>ìì—°ì–´ë¡œ ììœ ë¡­ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”</li>
                    <li>ì§€ì—­, ê°€ê²©, ë¬¼ê±´ ì¢…ë¥˜ ë“±ì„ ëª…ì‹œí•˜ë©´ ë” ì •í™•í•©ë‹ˆë‹¤</li>
                    <li>RAG ê¸°ë°˜ ê²€ìƒ‰ì€ Qdrantì™€ Ollamaê°€ í•„ìš”í•©ë‹ˆë‹¤</li>
                    <li>ì„œë¹„ìŠ¤ ë¯¸ì‹¤í–‰ ì‹œ í‚¤ì›Œë“œ ê²€ìƒ‰ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendBtn = document.getElementById('sendBtn');
    const exampleQuestions = document.querySelectorAll('.example-question');
    
    // localStorageì—ì„œ ëŒ€í™” ë‚´ìš© ë³µì›
    loadChatHistory();
    
    function loadChatHistory() {
        const history = localStorage.getItem('kamco_chat_history');
        if (history) {
            try {
                const messages = JSON.parse(history);
                // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±° (ì´ˆê¸° ì›°ì»´ ë©”ì‹œì§€ ì œì™¸)
                const welcomeMsg = chatMessages.firstElementChild;
                chatMessages.innerHTML = '';
                if (welcomeMsg) chatMessages.appendChild(welcomeMsg);
                
                // ì €ì¥ëœ ë©”ì‹œì§€ ë³µì›
                messages.forEach(msg => {
                    addMessage(msg.role, msg.content, msg.sources, msg.fallback, false);
                });
            } catch (e) {
                console.error('ëŒ€í™” ë‚´ìš© ë³µì› ì‹¤íŒ¨:', e);
            }
        }
    }
    
    function saveChatHistory() {
        const messages = [];
        chatMessages.querySelectorAll('.message').forEach(msg => {
            if (!msg.querySelector('.typing-indicator')) {
                const role = msg.classList.contains('user') ? 'user' : 'assistant';
                const contentEl = msg.querySelector('.message-content');
                if (contentEl) {
                    const content = contentEl.innerText.split('\nğŸ“š')[0].trim();
                    messages.push({ role, content });
                }
            }
        });
        localStorage.setItem('kamco_chat_history', JSON.stringify(messages.slice(-20))); // ìµœê·¼ 20ê°œë§Œ ì €ì¥
    }
    
    // ì˜ˆì‹œ ì§ˆë¬¸ í´ë¦­
    exampleQuestions.forEach(function(el) {
        el.addEventListener('click', function() {
            const question = this.dataset.question;
            chatInput.value = question;
            chatInput.focus();
        });
    });
    
    // í¼ ì œì¶œ
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = chatInput.value.trim();
        if (!question) return;
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addMessage('user', question);
        chatInput.value = '';
        
        // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
        sendBtn.disabled = true;
        
        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
        const typingId = addTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question })
            });
            
            const data = await response.json();
            
            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
            removeTypingIndicator(typingId);
            
            if (data.success) {
                addMessage('assistant', data.answer, data.sources, data.fallback);
            } else {
                addMessage('assistant', 'ì˜¤ë¥˜: ' + data.message);
            }
        } catch (error) {
            removeTypingIndicator(typingId);
            addMessage('assistant', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
            sendBtn.disabled = false;
            chatInput.focus();
        }
    });
    
    function addMessage(role, content, sources = null, fallback = false, save = true) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = role === 'user' ? '<i class="bi bi-person-fill"></i>' : '<i class="bi bi-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
        
        // ì¶œì²˜ ì •ë³´ ì¶”ê°€
        if (sources && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'message-sources';
            sourcesDiv.innerHTML = '<small><strong>ğŸ“š ì°¸ê³  ë¬¸ì„œ:</strong></small>';
            
            sources.forEach((source, index) => {
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';
                sourceItem.innerHTML = `<strong>${index + 1}.</strong> ${source.text} <span class="badge bg-primary">${(source.score * 100).toFixed(1)}%</span>`;
                sourcesDiv.appendChild(sourceItem);
            });
            
            contentDiv.appendChild(sourcesDiv);
        }
        
        // í´ë°± ëª¨ë“œ í‘œì‹œ
        if (fallback) {
            const fallbackBadge = document.createElement('div');
            fallbackBadge.className = 'mt-2';
            fallbackBadge.innerHTML = '<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> í‚¤ì›Œë“œ ê²€ìƒ‰ ëª¨ë“œ</span>';
            contentDiv.appendChild(fallbackBadge);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // localStorageì— ì €ì¥
        if (save) {
            saveChatHistory();
        }
    }
    
    function addTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        messageDiv.id = 'typing-indicator-' + Date.now();
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = '<i class="bi bi-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return messageDiv.id;
    }
    
    function removeTypingIndicator(id) {
        const indicator = document.getElementById(id);
        if (indicator) {
            indicator.remove();
        }
    }
    
    // ì±— ê¸°ë¡ ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById('resetChatBtn').addEventListener('click', function() {
        if (confirm('ì±— ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('kamco_chat_history');
            chatMessages.innerHTML = '';
            addMessage('assistant', 'ì•ˆë…•í•˜ì„¸ìš”! KAMCO ê³µë§¤ ë°ì´í„°ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”. ì˜ˆ: "ì„œìš¸ì— ìˆëŠ” ì•„íŒŒíŠ¸ ê²€ìƒ‰í•´ì£¼ì„¸ìš”"', null, false, false);
        }
    });
});
</script>
{% endblock %}
